#cloud-config
package_update: true
packages:
  - docker.io
  - nginx
  - jq
  - ca-certificates
  - openssl

write_files:
  # --- small wait helper for Nexus HTTP readiness
  - path: /usr/local/bin/nexus-wait.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      until curl -sf http://127.0.0.1:8081/service/rest/v1/status >/dev/null; do
        echo "[nexus-wait] Waiting for Nexus to be ready..."
        sleep 5
      done
      echo "[nexus-wait] Nexus is responding."

  # --- main provisioning script (password change, repo, TLS, nginx, seed push)
  - path: /usr/local/bin/provision-nexus.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      NEXUS_FQDN="${nexus_fqdn}"
      ADMIN_PASS_FILE="/nexus-data/admin.password"
      NEW_ADMIN_PASS="P@ssw0rd123!"

      echo "[provision] Using FQDN: $${NEXUS_FQDN}"

      # 1) Wait for Nexus UI
      /usr/local/bin/nexus-wait.sh

      # 2) Wait for admin password to be generated
      echo "[provision] Waiting for admin password file..."
      until [ -s "$${ADMIN_PASS_FILE}" ]; do
        sleep 5
      done
      ADMIN_PASS="$$(cat "$${ADMIN_PASS_FILE}")"
      echo "[provision] Got initial admin password."

      # 3) Change admin password to a known one (idempotent)
      echo "[provision] Changing admin password..."
      curl -sf -u "admin:$${ADMIN_PASS}" -X PUT \
        -H "Content-Type: application/json" \
        -d "{\"password\":\"$${NEW_ADMIN_PASS}\"}" \
        http://127.0.0.1:8081/service/rest/v1/security/users/admin/change-password || true

      AUTH="admin:$${NEW_ADMIN_PASS}"

      # 4) Create docker (hosted) repository on port 5000 (idempotent)
      echo "[provision] Creating docker-hosted repo (port 5000)..."
      curl -sf -u "$${AUTH}" -X POST \
        -H "Content-Type: application/json" \
        -d '{
              "name":"docker-hosted",
              "online":true,
              "storage":{"blobStoreName":"default","strictContentTypeValidation":true,"writePolicy":"ALLOW_ONCE"},
              "docker":{"v1Enabled":false,"forceBasicAuth":true,"httpPort":5000}
            }' \
        http://127.0.0.1:8081/service/rest/v1/repositories/docker/hosted || true

      # 5) Self-signed cert for POC (replace with ACME DNS-01 in prod)
      echo "[provision] Generating self-signed cert..."
      mkdir -p /etc/nginx/certs
      openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
        -keyout /etc/nginx/certs/nexus.key \
        -out    /etc/nginx/certs/nexus.crt \
        -subj "/CN=$${NEXUS_FQDN}"

      # 6) Nginx reverse proxy: 443 -> /v2/ to :5000, UI passthrough to :8081
      echo "[provision] Configuring Nginx..."
      cat >/etc/nginx/sites-available/nexus <<'NGINX'
      map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
      }
      server {
        listen 443 ssl;
        server_name NEXUS_FQDN;

        ssl_certificate     /etc/nginx/certs/nexus.crt;
        ssl_certificate_key /etc/nginx/certs/nexus.key;

        # Registry API
        location /v2/ {
          proxy_pass http://127.0.0.1:5000;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto https;
        }

        # Nexus UI
        location / {
          proxy_pass http://127.0.0.1:8081;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto https;
        }
      }
      NGINX
      sed -i "s/NEXUS_FQDN/$${NEXUS_FQDN}/g" /etc/nginx/sites-available/nexus
      ln -sf /etc/nginx/sites-available/nexus /etc/nginx/sites-enabled/nexus
      rm -f /etc/nginx/sites-enabled/default
      systemctl restart nginx

      # 7) Trust the self-signed cert for the local Docker client (seed push)
      echo "[provision] Trusting self-signed cert for Docker client on the VM..."
      mkdir -p "/etc/docker/certs.d/$${NEXUS_FQDN}"
      cp /etc/nginx/certs/nexus.crt "/etc/docker/certs.d/$${NEXUS_FQDN}/ca.crt"
      systemctl restart docker

      # 8) Seed: push a sample image to nexus (busybox:latest)
      echo "[provision] Logging into registry and pushing sample image..."
      echo "$${NEW_ADMIN_PASS}" | docker login "https://$${NEXUS_FQDN}" -u admin --password-stdin
      docker pull busybox:latest
      docker tag busybox:latest "$${NEXUS_FQDN}/docker-hosted/busybox:latest"
      docker push "$${NEXUS_FQDN}/docker-hosted/busybox:latest"

  # --- systemd unit written by cloud-init (no heredocs in runcmd anymore)
  - path: /etc/systemd/system/nexus.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Nexus via Docker
      After=network-online.target docker.service
      Wants=network-online.target docker.service
      RequiresMountsFor=/nexus-data

      [Service]
      Type=simple
      Restart=always
      # Ensure proper ownership every start (idempotent)
      ExecStartPre=/usr/bin/chown -R 200:200 /nexus-data
      ExecStartPre=/usr/bin/mkdir -p /nexus-data
      # Remove any stale container from previous runs to make this idempotent
      ExecStartPre=/usr/bin/docker rm -f nexus || true
      ExecStart=/usr/bin/docker run --name nexus \
        -p 8081:8081 -p 5000:5000 \
        -v /nexus-data:/nexus-data \
        sonatype/nexus3:latest
      ExecStop=/usr/bin/docker rm -f nexus

      [Install]
      WantedBy=multi-user.target

runcmd:
  # 1) Format + mount the data disk at /nexus-data (LUN 0)
  - [ bash, -lc, 'mkfs.ext4 -F /dev/disk/azure/scsi1/lun0 || true' ]
  - [ bash, -lc, 'mkdir -p /nexus-data && echo "/dev/disk/azure/scsi1/lun0 /nexus-data ext4 defaults,nofail 0 2" >> /etc/fstab && mount -a' ]
  - [ bash, -lc, 'chown -R 200:200 /nexus-data && chmod 700 /nexus-data' ]  
  # 2) Docker up
  - [ systemctl, enable, --now, docker ]

  # 3) Make sure unit isnâ€™t masked, then start Nexus cleanly
  - [ systemctl, daemon-reload ]
  - [ systemctl, unmask, nexus ]
  - [ systemctl, enable, --now, nexus ]

  # 4) Configure Nginx, TLS, repo, and seed image
  - [ bash, -lc, '/usr/local/bin/provision-nexus.sh' ]
