#cloud-config
package_update: true
packages:
  - docker.io
  - jq
  - openssl
  - curl
  - unzip
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

write_files:
  - path: /usr/local/bin/sync_remote_acr_acr.sh
    permissions: "0755"
    owner: root:root
    encoding: b64
    content: ${sync_remote_acr_acr_b64}

  - path: /etc/remote_acr_images.list
    permissions: "0644"
    owner: root:root
    content: |
      %{ for img in remote_acr_images ~}
      ${img}
      %{ endfor ~}

  - path: /etc/sbx.env
    permissions: "0600"
    owner: root:root
    content: |
      ACR_NAME=${acr_name}
      REMOTE_ACR_USERNAME=${remote_acr_username}
      REMOTE_ACR_PASSWORD=${remote_acr_password}
      REMOTE_ACR_FQDN=${remote_acr_fqdn}

runcmd:
  - [ bash, -lc, 'curl -sL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/microsoft.gpg >/dev/null' ]
  - [ bash, -lc, 'AZ_REPO=$(lsb_release -cs) && echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" > /etc/apt/sources.list.d/azure-cli.list' ]
  - [ bash, -lc, 'apt-get update && apt-get install -y azure-cli' ]
  - [ bash, -lc, 'mkfs.ext4 -F /dev/disk/azure/scsi1/lun0 || true' ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, --now, docker ]
