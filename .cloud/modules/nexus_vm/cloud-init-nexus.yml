#cloud-config
package_update: true
packages:
  - docker.io
  - nginx
  - jq
  - ca-certificates
  - openssl
  - curl
  - unzip

write_files:
  - path: /usr/local/bin/test-auth.sh
    permissions: "0755"
    owner: root:root
    encoding: b64
    content: ${test_auth_script_b64}

  - path: /etc/default/nexus-fqdn
    permissions: "0644"
    owner: root:root
    content: |
      FQDN="${nexus_fqdn}"

  - path: /usr/local/bin/ensure-sni-cert.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      if [ -f /etc/default/nexus-fqdn ]; then . /etc/default/nexus-fqdn; fi
      set +u
      if [ -z "$FQDN" ]; then FQDN="$(hostname -f 2>/dev/null || hostname)"; fi
      set -u

      cert_dir=/etc/nginx/certs
      cert=$cert_dir/fullchain.pem
      key=$cert_dir/privkey.pem
      cfg=$cert_dir/openssl-san.cnf

      mkdir -p "$cert_dir"
      umask 077
      cat >"$cfg" <<EOF
      [req]
      default_bits = 2048
      prompt       = no
      default_md   = sha256
      distinguished_name = dn
      req_extensions     = v3_req
      [dn]
      CN = $FQDN
      [v3_req]
      subjectAltName = @alt_names
      keyUsage = critical, digitalSignature, keyEncipherment
      extendedKeyUsage = serverAuth
      [alt_names]
      DNS.1 = $FQDN
      EOF

      regen=1
      if [ -s "$cert" ]; then
        if openssl x509 -in "$cert" -noout -ext subjectAltName 2>/dev/null | grep -q "DNS:$FQDN"; then
          regen=0
        fi
      fi

      if [ "$regen" -eq 1 ]; then
        echo "[ensure-sni-cert] Generating SAN cert for $FQDN"
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
          -keyout "$key" -out "$cert" -config "$cfg" -extensions v3_req
        chmod 600 "$key"
        chmod 644 "$cert"
      fi

      openssl x509 -in "$cert" -noout -ext subjectAltName | grep -q "DNS:$FQDN"
      echo "[ensure-sni-cert] OK for $FQDN"

  - path: /etc/nginx/conf.d/nexus.conf
    permissions: "0644"
    owner: root:root
    content: |
      server {
        listen 443 ssl http2 default_server;
        server_name _;

        ssl_certificate     /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key /etc/nginx/certs/privkey.pem;

        ssl_session_timeout 1d;
        ssl_protocols TLSv1.2 TLSv1.3;

        location /v2/ {
          proxy_pass http://127.0.0.1:5000;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto https;
          proxy_read_timeout 900;
        }

        location / {
          proxy_pass http://127.0.0.1:8081/;
          proxy_set_header Host $host;
          proxy_set_header X-Forwarded-Proto https;
        }
      }

  - path: /opt/nexus-build/Dockerfile
    permissions: "0644"
    owner: root:root
    encoding: b64
    content: ${dockerfile_content_b64}

  - path: /usr/local/bin/provision-nexus.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      if [ -f /etc/default/nexus-fqdn ]; then . /etc/default/nexus-fqdn; fi
      set +u
      if [ -z "$FQDN" ]; then FQDN="$(hostname -f 2>/dev/null || hostname)"; fi
      set -u

      NEW_PASS='${nexus_password}'
      AUTH="admin:$${NEW_PASS}"

      retry() {
        local attempts="$1"; shift
        local delay="$1"; shift
        local n=1
        while true; do
          if "$@"; then return 0; fi
          if [ "$n" -ge "$attempts" ]; then return 1; fi
          n=$((n+1))
          sleep "$delay"
        done
      }

      echo "[provision] Wait Nexus 8081..."
      retry 60 2 curl -sf http://127.0.0.1:8081/service/rest/v1/status >/dev/null

      INIT_PASS="$(tr -d '\r\n' </nexus-data/admin.password)"
      AUTH_INIT="admin:$INIT_PASS"

      echo "[provision] Change admin password..."
      retry 5 2 curl -sf -u "$AUTH_INIT" -X PUT \
        -H 'Content-Type: text/plain' \
        -H 'X-Requested-By: cli' \
        --data "$NEW_PASS" \
        http://127.0.0.1:8081/service/rest/v1/security/users/admin/change-password

      echo "[provision] Accept EULA..."
      EULA="$(curl -sf -u "$AUTH" http://127.0.0.1:8081/service/rest/v1/system/eula)"
      if [ "$(echo "$EULA" | jq -r .accepted)" != "true" ]; then
        echo "$EULA" \
        | jq -c '{accepted:true, disclaimer:.disclaimer}' \
        | curl -sf -u "$AUTH" -H 'Content-Type: application/json' -H 'X-Requested-By: cli' -d @- \
            http://127.0.0.1:8081/service/rest/v1/system/eula
      fi

      echo "[provision] Ensure DockerToken realm enabled..."
      for i in $(seq 1 30); do
        current="$(curl -sS -u "$AUTH" -H 'X-Requested-By: cli' \
          http://127.0.0.1:8081/service/rest/v1/security/realms/active || true)"

        if echo "$current" | jq -e 'index("DockerToken") != null' >/dev/null 2>&1; then
          echo "[provision] DockerToken already active"
          break
        fi

        code=$(curl -sS -o /dev/null -w "%%{http_code}" -u "$AUTH" -X PUT \
          -H 'Content-Type: application/json' -H 'X-Requested-By: cli' \
          --data '["NexusAuthenticatingRealm","NexusAuthorizingRealm","DockerToken"]' \
          http://127.0.0.1:8081/service/rest/v1/security/realms/active || true)

        if [ "$code" -ge 200 ] && [ "$code" -lt 300 ]; then
          echo "[provision] Realms updated ($code)"
          break
        fi

        echo "[provision] Realms not ready (code=$code), retry..."
        sleep 2
      done

      echo "[provision] Recreate docker-hosted on 5000..."
      curl -sf -u "$AUTH" -X DELETE -H 'X-Requested-By: cli' \
        http://127.0.0.1:8081/service/rest/v1/repositories/docker-hosted || true

      cat <<'JSON' \
      | curl -sf -u "$AUTH" -X POST -H 'Content-Type: application/json' -H 'X-Requested-By: cli' -d @- \
          http://127.0.0.1:8081/service/rest/v1/repositories/docker/hosted
      {
        "name":"docker-hosted",
        "online":true,
        "storage":{"blobStoreName":"default","strictContentTypeValidation":true,"writePolicy":"ALLOW_ONCE"},
        "docker":{"v1Enabled":false,"forceBasicAuth":true,"httpPort":5000}
      }
      JSON

      echo "[provision] Wait registry v2 on :5000..."
      retry 60 2 bash -lc 'curl -sI http://127.0.0.1:5000/v2/ | grep -q " 401"'

      echo "[provision] Update nginx server_name to FQDN and reload..."
      sed -i -E "s/^[[:space:]]*server_name[[:space:]]+.*/server_name $${FQDN};/" /etc/nginx/conf.d/nexus.conf

      echo "[provision] Reload nginx..."
      nginx -t && systemctl reload nginx

      echo "[provision] DONE."

  - path: /usr/local/bin/build-custom-image.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      
      IMAGE_NAME="$${1:-todo-app-api:latest}"
      CONTEXT_URL="${docker_context_url}"
      
      mkdir -p /opt/nexus-build
      cd /opt/nexus-build

      if [ -n "$CONTEXT_URL" ]; then
        echo "[build] Downloading context from $CONTEXT_URL..."
        
        # Install Azure CLI if missing
        if ! command -v az >/dev/null 2>&1; then
            curl -sL https://aka.ms/InstallAzureCLIDeb | bash
        fi
        
        # Login with Managed Identity
        az login --identity --allow-no-subscriptions
        
        # Retry download to handle propagation delays
        for i in {1..10}; do
          if az storage blob download --auth-mode login --blob-url "$CONTEXT_URL" --file context.zip; then
            break
          fi
          echo "[build] Download failed, retrying in 10s..."
          sleep 10
        done
      fi

      if [ -s /opt/nexus-build/Dockerfile ] && [ -s context.zip ]; then
        echo "[build] Found Dockerfile and context, building custom image $IMAGE_NAME..."
        unzip -o context.zip
        docker build -t "$IMAGE_NAME" .
      else
        echo "[build] No Dockerfile or context found, skipping build."
      fi

  - path: /etc/systemd/system/nginx.service.d/override.conf
    permissions: "0644"
    owner: root:root
    content: |
      [Service]
      ExecStartPre=
      ExecStartPre=/usr/local/bin/ensure-sni-cert.sh
      ExecStartPre=/usr/sbin/nginx -t -q -g 'daemon on; master_process on;'

  - path: /etc/systemd/system/ensure-sni-cert.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Ensure self-signed certificate with SAN exists
      After=network-online.target
      Wants=network-online.target
      Before=nginx.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/ensure-sni-cert.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/nexus.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Nexus via Docker
      After=network-online.target docker.service
      Wants=network-online.target docker.service
      Requires=docker.service
      RequiresMountsFor=/nexus-data

      [Service]
      Type=simple
      Restart=on-failure
      RestartSec=5s
      TimeoutStartSec=0

      ExecStartPre=/usr/bin/mkdir -p /nexus-data
      ExecStartPre=/usr/bin/chown -R 200:200 /nexus-data
      ExecStartPre=/bin/bash -lc 'until /usr/bin/docker info >/dev/null 2>&1; do sleep 1; done'
      ExecStartPre=/bin/bash -lc '/usr/bin/docker rm -f nexus || true'
      ExecStartPre=/bin/bash -lc '/usr/bin/docker image inspect sonatype/nexus3:latest >/dev/null 2>&1 || /usr/bin/docker pull sonatype/nexus3:latest'

      ExecStart=/usr/bin/docker run --name nexus \
        -p 8081:8081 -p 5000:5000 \
        -v /nexus-data:/nexus-data \
        sonatype/nexus3:latest

      ExecStop=/usr/bin/docker rm -f nexus

      [Install]
      WantedBy=multi-user.target


  - path: /usr/local/bin/nexus-wait.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      for i in {1..600}; do
        [[ -f /var/lib/cloud/instance/boot-finished ]] && break
        sleep 1
      done

      for i in {1..300}; do
        if command -v /usr/bin/docker >/dev/null 2>&1 && systemctl is-active --quiet docker; then
          [[ -S /var/run/docker.sock ]] && break
        fi
        echo "[wait] docker runtime..."
        sleep 2
      done

      for i in {1..900}; do
        if /usr/bin/docker ps --filter name=^/nexus$ --filter status=running -q | grep -q .; then
          break
        fi
        echo "[wait] nexus container..."
        sleep 3
      done

      ok=0
      for i in {1..120}; do
        if curl -sfI http://127.0.0.1:8081/service/rest/v1/status >/dev/null; then
          ok=$((ok+1))
          [[ $ok -ge 2 ]] && exit 0
        else
          ok=0
        fi
        echo "[wait] nexus api 8081..."
        sleep 3
      done

      echo "[wait] timeout waiting nexus api" >&2
      exit 1

  - path: /etc/nexus-acr-sync.env
    permissions: "0600"
    owner: root:root
    content: |
      ACR_NAME=${acr_name}
      NEXUS_HOST=127.0.0.1:5000
      NEXUS_SCHEME=http
      NEXUS_USERNAME=admin
      NEXUS_PASSWORD='${nexus_password}'
      DOCKERHUB_USERNAME=${dockerhub_username}
      DOCKERHUB_PASSWORD=${dockerhub_password}
      SEED_BATCH_SIZE=${seed_config.batch_size}
      ENABLE_SYNC_TO_ACR=${sync_config.enable}

  - path: /etc/nexus-seed.list
    permissions: "0644"
    owner: root:root
    content: |
      %{ for img in seed_config.images ~}
      ${img}
      %{ endfor ~}

  - path: /usr/local/bin/seed-dockerhub-to-nexus.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      source /etc/nexus-acr-sync.env

      BASE="$${NEXUS_SCHEME}://$${NEXUS_HOST}"
      SEED_LIST="/etc/nexus-seed.list"
      STATE_DIR="/var/lib/nexus-seed"; mkdir -p "$STATE_DIR"
      DONE_FILE="$STATE_DIR/seeded.log"; touch "$DONE_FILE"

      # Wait for Docker & /v2 readiness
      until [ -S /var/run/docker.sock ]; do sleep 1; done
      for i in {1..60}; do
        if curl -sSI "$BASE/v2/" | grep -qE 'HTTP/.* (200|401)'; then break; fi
        sleep 2
      done

      if [[ -n "$${DOCKERHUB_USERNAME:-}" && -n "$${DOCKERHUB_PASSWORD:-}" ]]; then
        echo "$${DOCKERHUB_PASSWORD}" | docker login docker.io --username "$${DOCKERHUB_USERNAME}" --password-stdin
      fi
      printf '%s' "$${NEXUS_PASSWORD}" | docker login "$${NEXUS_HOST}" --username "$${NEXUS_USERNAME}" --password-stdin

      to_seed=0
      grep -v '^\s*$' "$SEED_LIST" | while read -r src; do
        grep -qxF "$src" "$DONE_FILE" && continue
        (( to_seed+=1 ))

        # Check local image first, else pull from docker.io  
        if docker image inspect "$src" >/dev/null 2>&1; then
            echo "[seed] Found local image: $src"
            docker tag "$src" "$${NEXUS_HOST}/$src"
        else
            echo "[seed] Pulling docker.io/$src"
            docker pull "docker.io/$src"
            docker tag  "docker.io/$src" "$${NEXUS_HOST}/$src"
        fi

        echo "[seed] Pushing $${NEXUS_HOST}/$src"
        docker push "$${NEXUS_HOST}/$src"
        echo "$src" >> "$DONE_FILE"
        if [[ "$${SEED_BATCH_SIZE:-1}" -gt 0 && "$to_seed" -ge "$${SEED_BATCH_SIZE:-1}" ]]; then
            break
        fi
      done

  - path: /usr/local/bin/mirror-all-nexus-to-acr.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      source /etc/nexus-acr-sync.env

      [[ "$${ENABLE_SYNC_TO_ACR}" == "true" || "$${ENABLE_SYNC_TO_ACR}" == "1" ]] || exit 0

      BASE="$${NEXUS_SCHEME}://$${NEXUS_HOST}"
      ACR_LOGIN_SERVER="$${ACR_NAME}.azurecr.io"

      # Ensure Docker & /v2 readiness
      until [ -S /var/run/docker.sock ]; do sleep 1; done
      for i in {1..60}; do
        if curl -sSI "$BASE/v2/" | grep -qE 'HTTP/.* (200|401)'; then break; fi
        sleep 2
      done

      # MI login (no subs required) + robust ACR docker auth
      az login --identity --allow-no-subscriptions 1>/dev/null
      if ! az acr login -n "$${ACR_NAME}" 1>/dev/null 2>&1; then
        TOK=$(az acr login -n "$${ACR_NAME}" --expose-token -o tsv --query accessToken)
        echo "$TOK" | docker login "$ACR_LOGIN_SERVER" \
          --username 00000000-0000-0000-0000-000000000000 --password-stdin
      fi

      printf '%s' "$${NEXUS_PASSWORD}" | docker login "$${NEXUS_HOST}" --username "$${NEXUS_USERNAME}" --password-stdin

      repos=$(curl -fsSL -u "$${NEXUS_USERNAME}:$${NEXUS_PASSWORD}" "$${BASE}/v2/_catalog?n=1000" | jq -r '.repositories[]' )
      for repo in $repos; do
        tags=$(curl -fsSL -u "$${NEXUS_USERNAME}:$${NEXUS_PASSWORD}" "$${BASE}/v2/$repo/tags/list" | jq -r '.tags[]?' || true)
        for tag in $tags; do
          src="$${NEXUS_HOST}/$repo:$tag"
          dst="$${ACR_NAME}.azurecr.io/$repo:$tag"
          echo "[mirror] $${src} -> $${dst}"
          docker pull "$${src}" || { echo "pull failed: $${src}" >&2; continue; }
          docker tag  "$${src}" "$${dst}"
          docker push "$${dst}" || { echo "push failed: $${dst}" >&2; continue; }
        done
      done

  - path: /usr/local/bin/provision-acr-sync.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      # Ensure docker up
      systemctl enable --now docker || true
      until systemctl is-active --quiet docker; do sleep 2; done
      until [ -S /var/run/docker.sock ]; do sleep 2; done

      # Allow HTTP push to localhost:5000 (insecure registry)
      mkdir -p /etc/docker
      if ! grep -q '"insecure-registries"' /etc/docker/daemon.json 2>/dev/null; then
        cat >/etc/docker/daemon.json <<'JSON'
      { "insecure-registries": ["127.0.0.1:5000"] }
      JSON
        systemctl restart docker
        until [ -S /var/run/docker.sock ]; do sleep 2; done
      fi

      # Install Azure CLI if missing
      if ! command -v az >/dev/null 2>&1; then
        curl -sL https://aka.ms/InstallAzureCLIDeb | bash
      fi

      # First batch seed (if list present) then first mirror
      if [[ -s /etc/nexus-seed.list ]]; then
        /usr/local/bin/seed-dockerhub-to-nexus.sh || true
      fi
      /usr/local/bin/mirror-all-nexus-to-acr.sh || true

      # Enable timers
      systemctl daemon-reload
      systemctl enable --now nexus-acr-mirror.timer || true
      systemctl enable --now nexus-seed.timer || true

# systemd units for periodic tasks
  - path: /etc/systemd/system/nexus-acr-mirror.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Mirror Nexus images to Azure Container Registry
      After=network-online.target docker.service nexus.service
      Wants=network-online.target docker.service nexus.service
      [Service]
      Type=oneshot
      EnvironmentFile=/etc/nexus-acr-sync.env
      ExecStart=/usr/local/bin/mirror-all-nexus-to-acr.sh

  - path: /etc/systemd/system/nexus-acr-mirror.timer
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Run Nexusâ†’ACR mirror periodically
      [Timer]
      OnBootSec=2min
      OnUnitActiveSec=${sync_config.timer_every}
      Persistent=true
      [Install]
      WantedBy=timers.target

  - path: /etc/systemd/system/nexus-seed.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Seed Docker Hub images into Nexus (batch)
      After=network-online.target docker.service nexus.service
      Wants=network-online.target docker.service nexus.service
      [Service]
      Type=oneshot
      EnvironmentFile=/etc/nexus-acr-sync.env
      ExecStart=/usr/local/bin/seed-dockerhub-to-nexus.sh

  - path: /etc/systemd/system/nexus-seed.timer
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=Run Docker Hub -> Nexus seeding periodically (batch)
      [Timer]
      OnBootSec=2min
      OnUnitActiveSec=${seed_config.timer_every}
      Persistent=true
      [Install]
      WantedBy=timers.target


runcmd:
  - [ bash, -lc, 'mkfs.ext4 -F /dev/disk/azure/scsi1/lun0 || true' ]
  - [ bash, -lc, 'mkdir -p /nexus-data && echo "/dev/disk/azure/scsi1/lun0 /nexus-data ext4 defaults,nofail 0 2" >> /etc/fstab && mount -a' ]
  - [ bash, -lc, 'chown -R 200:200 /nexus-data && chmod 700 /nexus-data' ]
  - [ systemctl, daemon-reload ]
  - [ systemctl, enable, --now, docker ]
  - [ systemctl, enable, --now, ensure-sni-cert.service ]
  - [ systemctl, enable, --now, nexus ]
  - [ systemctl, enable, --now, nginx ]
